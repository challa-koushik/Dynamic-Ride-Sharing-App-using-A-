{% extends "base.html" %}

{% block title %}Pool Ride Route{% endblock %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        background: #f5f7fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .route-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 24px;
    }
    
    .route-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 24px 32px;
        border-radius: 16px;
        color: white;
        margin-bottom: 24px;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
    }
    
    .route-header h1 {
        font-size: 28px;
        margin-bottom: 8px;
    }
    
    .route-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .summary-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .summary-title {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 8px;
    }
    
    .summary-value {
        font-size: 24px;
        font-weight: 700;
        color: #1f2937;
    }
    
    .passengers-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .passengers-grid {
        display: grid;
        gap: 12px;
        margin-top: 16px;
    }
    
    .passenger-card {
        padding: 16px;
        border-left: 4px solid #10b981;
        background: #f0fdf4;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .passenger-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .passenger-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #10b981;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
    }
    
    .passenger-details strong {
        display: block;
        margin-bottom: 4px;
        color: #1f2937;
    }
    
    .passenger-route {
        font-size: 14px;
        color: #6b7280;
    }
    
    .route-badge {
        padding: 6px 12px;
        background: #10b981;
        color: white;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
    }
    
    #map {
        width: 100%;
        height: 650px;
        border-radius: 16px;
        border: 2px solid #e5e7eb;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }
    
    .legend {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }
    
    .legend-items {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .legend-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .btn-back {
        display: inline-block;
        padding: 14px 28px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-back:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
</style>

<div class="route-container">
    <div class="route-header">
        <h1>üöó Pool Ride - Optimized Route</h1>
        <p>Shared ride with {{ rides|length }} passenger{{ 's' if rides|length > 1 else '' }}</p>
    </div>
    
    <div class="route-summary">
        <div class="summary-card">
            <div class="summary-title">üë• Passengers</div>
            <div class="summary-value">{{ rides|length }}</div>
        </div>
        <div class="summary-card">
            <div class="summary-title">üìç Starting Point</div>
            <div class="summary-value" style="font-size: 18px;">{{ rider_location.city }}</div>
        </div>
        <div class="summary-card">
            <div class="summary-title">üéØ Destinations</div>
            <div class="summary-value">{{ route_data.dropoffs|length }}</div>
        </div>
    </div>
    
    <div class="passengers-section">
        <h3 style="margin-bottom: 16px; color: #1f2937;">üìã Passengers</h3>
        <div class="passengers-grid">
            {% for ride in rides %}
            <div class="passenger-card">
                <div class="passenger-info">
                    <div class="passenger-avatar">
                        {{ ride.user_name[0]|upper }}
                    </div>
                    <div class="passenger-details">
                        <strong>{{ ride.user_name }}</strong>
                        <span class="passenger-route">
                            üîµ {{ ride.source }} ‚Üí üî¥ {{ ride.destination }}
                        </span>
                    </div>
                </div>
                <div class="route-badge">Via: {{ ride.path }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="legend">
        <h4 style="margin-bottom: 12px; color: #1f2937;">üó∫Ô∏è Map Legend</h4>
        <div class="legend-items">
            <div class="legend-item">
                <div class="legend-icon" style="background: #10b981;"></div>
                <span>Rider Location</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #3b82f6;"></div>
                <span>Pickup Points</span>
            </div>
            <div class="legend-item">
                <div class="legend-icon" style="background: #ef4444;"></div>
                <span>Drop-off Points</span>
            </div>
            <div class="legend-item">
                <div style="width: 40px; height: 4px; background: #8b5cf6; border-radius: 2px;"></div>
                <span>Optimized Route</span>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div style="text-align: center;">
        <a href="{{ url_for('rider_dashboard') }}" class="btn-back">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>

<!-- OpenLayers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.2.1/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v10.2.1/dist/ol.js"></script>

<script>
const riderLocation = {{ rider_location|tojson }};
const routeData = {{ route_data|tojson }};
const rides = {{ rides|tojson }};

console.log('üöó Route Data:', routeData);

// Initialize map
const map = new ol.Map({
    target: 'map',
    layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM()
        })
    ],
    view: new ol.View({
        center: ol.proj.fromLonLat([riderLocation.lon, riderLocation.lat]),
        zoom: 10
    })
});

// Create vector layer for markers and routes
const vectorSource = new ol.source.Vector();
const vectorLayer = new ol.layer.Vector({
    source: vectorSource
});
map.addLayer(vectorLayer);

// Add rider marker (green - starting point)
const riderMarker = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat([riderLocation.lon, riderLocation.lat]))
});

riderMarker.setStyle(new ol.style.Style({
    image: new ol.style.Circle({
        radius: 12,
        fill: new ol.style.Fill({ color: '#10b981' }),
        stroke: new ol.style.Stroke({ color: 'white', width: 3 })
    }),
    text: new ol.style.Text({
        text: 'üöó',
        font: '16px sans-serif',
        offsetY: -20
    })
}));

vectorSource.addFeature(riderMarker);

// Add pickup markers (blue)
routeData.pickups.forEach((pickup, index) => {
    const marker = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([pickup.coords[1], pickup.coords[0]]))
    });
    
    marker.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 10,
            fill: new ol.style.Fill({ color: '#3b82f6' }),
            stroke: new ol.style.Stroke({ color: 'white', width: 2 })
        }),
        text: new ol.style.Text({
            text: (index + 1).toString(),
            fill: new ol.style.Fill({ color: 'white' }),
            font: 'bold 12px sans-serif'
        })
    }));
    
    vectorSource.addFeature(marker);
});

// Add dropoff markers (red)
routeData.dropoffs.forEach((dropoff, index) => {
    const marker = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([dropoff.coords[1], dropoff.coords[0]]))
    });
    
    marker.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 10,
            fill: new ol.style.Fill({ color: '#ef4444' }),
            stroke: new ol.style.Stroke({ color: 'white', width: 2 })
        }),
        text: new ol.style.Text({
            text: 'üéØ',
            font: '14px sans-serif',
            offsetY: -18
        })
    }));
    
    vectorSource.addFeature(marker);
});

// Draw route using OSRM for real road paths
async function drawRealRoute() {
    try {
        // Build coordinate list for OSRM
        const coordinates = routeData.coords.map(coord => `${coord[1]},${coord[0]}`).join(';');
        
        // Call OSRM API for real road routing
        const response = await fetch(
            `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`
        );
        
        const data = await response.json();
        
        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
            const route = data.routes[0];
            const routeCoords = route.geometry.coordinates;
            
            // Convert to OpenLayers format
            const lineCoords = routeCoords.map(coord => ol.proj.fromLonLat(coord));
            
            const routeLine = new ol.Feature({
                geometry: new ol.geom.LineString(lineCoords)
            });
            
            routeLine.setStyle(new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#8b5cf6',
                    width: 4
                })
            }));
            
            vectorSource.addFeature(routeLine);
            
            console.log(`‚úÖ Real road route drawn: ${route.distance / 1000} km`);
        } else {
            // Fallback to straight line if OSRM fails
            drawStraightRoute();
        }
    } catch (error) {
        console.error('Error fetching OSRM route:', error);
        drawStraightRoute();
    }
}

function drawStraightRoute() {
    // Fallback: Draw straight line through waypoints
    const lineCoords = routeData.coords.map(coord => 
        ol.proj.fromLonLat([coord[1], coord[0]])
    );
    
    const routeLine = new ol.Feature({
        geometry: new ol.geom.LineString(lineCoords)
    });
    
    routeLine.setStyle(new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: '#8b5cf6',
            width: 4,
            lineDash: [10, 5]
        })
    }));
    
    vectorSource.addFeature(routeLine);
    console.log('‚ö†Ô∏è Using fallback straight-line route');
}

// Fit map to show all markers
const extent = vectorSource.getExtent();
map.getView().fit(extent, {
    padding: [50, 50, 50, 50],
    duration: 1000
});

// Draw the route with real roads
drawRealRoute();

console.log('‚úÖ Pool ride map loaded successfully');
</script>

{% endblock %}
