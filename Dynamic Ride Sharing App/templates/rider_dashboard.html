{% extends "base.html" %}

{% block title %}Rider Dashboard - RideShare{% endblock %}

{% block content %}
<div class="rider-container">
    <!-- Header with gradient -->
    <div class="rider-header">
        <div class="header-left">
            <h1>🏍️ Rider Dashboard</h1>
            <p class="welcome-text">Welcome back, <strong>{{ rider }}</strong>!</p>
        </div>
        <div class="header-right">
            <div class="status-badge online">
                <span class="status-dot"></span>
                <span>Online</span>
            </div>
        </div>
    </div>
    
    <!-- Pool Mode Panel (Hidden by default) -->
    <div class="pool-mode-banner" id="poolModeBanner" style="display: none;">
        <div class="pool-banner-content">
            <div class="pool-info">
                <h3>🚗 Pool Mode Active</h3>
                <p><span id="selectedCount">0</span> rides selected for pooling</p>
            </div>
            <div class="pool-actions">
                <button class="btn-pool-accept" id="acceptPoolBtn" disabled>
                    Accept Pool Rides
                </button>
                <button class="btn-pool-cancel" id="cancelPoolBtn">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Statistics Dashboard -->
    <div class="stats-container">
        <div class="stat-box total">
            <div class="stat-icon">📊</div>
            <div class="stat-content">
                <div class="stat-number">{{ rides|length }}</div>
                <div class="stat-label">Total Requests</div>
            </div>
        </div>
        <div class="stat-box pending">
            <div class="stat-icon">⏰</div>
            <div class="stat-content">
                <div class="stat-number">{{ rides|selectattr('status', 'equalto', 'pending')|list|length }}</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
        <div class="stat-box accepted">
            <div class="stat-icon">✅</div>
            <div class="stat-content">
                <div class="stat-number">{{ rides|selectattr('status', 'equalto', 'accepted')|list|length }}</div>
                <div class="stat-label">Accepted</div>
            </div>
        </div>
    </div>
    
    <!-- Current Location Card -->
    <div class="location-card">
        <div class="location-icon">📍</div>
        <div class="location-details">
            <h3>Your Current Location</h3>
            <p class="coordinates">
                {{ "%.4f"|format(rider_lat) }}°N, {{ "%.4f"|format(rider_lon) }}°E
            </p>
        </div>
    </div>
    
    <!-- Section Header with Pool Mode Toggle -->
    <div class="section-toolbar">
        <h2>Available Ride Requests</h2>
        <button class="btn-toggle-pool" id="togglePoolBtn">
            <span class="pool-icon">🚗</span>
            <span class="pool-text">Enable Pool Mode</span>
        </button>
    </div>
    
    <!-- Rides List -->
    {% if rides %}
    <div class="rides-container">
        {% for ride in rides %}
        <div class="ride-card {% if ride.status == 'accepted' %}card-accepted{% elif ride.status == 'completed' %}card-completed{% endif %}" data-ride-id="{{ ride.id }}">
            
            <!-- Pool Mode Checkbox -->
            <div class="pool-select-box" style="display: none;">
                <input type="checkbox" class="pool-checkbox" id="ride-{{ ride.id }}" data-ride-id="{{ ride.id }}">
                <label for="ride-{{ ride.id }}" class="checkbox-label"></label>
            </div>
            
            <!-- Status Tag -->
            <div class="status-tag status-{{ ride.status }}">
                {% if ride.status == 'pending' %}
                    🔔 New Request
                {% elif ride.status == 'accepted' %}
                    ✅ Accepted
                {% else %}
                    ✓ Completed
                {% endif %}
            </div>
            
            <!-- User Info Section -->
            <div class="user-section">
                <div class="user-avatar">
                    {{ ride.user_name[0]|upper }}
                </div>
                <div class="user-info">
                    <h4 class="user-name">{{ ride.user_name }}</h4>
                    <p class="user-email">{{ ride.user_email }}</p>
                </div>
            </div>
            
            <!-- Route Visualization -->
            <div class="route-section">
                <div class="route-points">
                    <div class="point pickup">
                        <div class="point-dot blue"></div>
                        <div class="point-text">
                            <span class="point-label">Pickup</span>
                            <span class="point-location">{{ ride.source }}</span>
                        </div>
                    </div>
                    <div class="route-connector"></div>
                    <div class="point dropoff">
                        <div class="point-dot red"></div>
                        <div class="point-text">
                            <span class="point-label">Drop-off</span>
                            <span class="point-location">{{ ride.destination }}</span>
                        </div>
                    </div>
                </div>
                <div class="route-path-text">
                    <strong>Via:</strong> {{ ride.path }}
                </div>
            </div>
            
            <!-- Distance & Time Info -->
            <div class="ride-metrics">
                <div class="metric highlighted">
                    <div class="metric-icon">📏</div>
                    <div class="metric-details">
                        <div class="metric-value">{{ ride.rider_distance }} km</div>
                        <div class="metric-label">To Pickup</div>
                    </div>
                </div>
                <div class="metric">
                    <div class="metric-icon">⏱️</div>
                    <div class="metric-details">
                        <div class="metric-value">{{ ride.pickup_time }} min</div>
                        <div class="metric-label">ETA</div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="card-actions">
                <a href="{{ url_for('show_route', ride_id=ride.id) }}" class="btn-action btn-view">
                    🗺️ View Route
                </a>
                {% if ride.status == 'pending' %}
                <a href="{{ url_for('accept_ride', ride_id=ride.id) }}" class="btn-action btn-accept">
                    ✓ Accept Ride
                </a>
                {% endif %}
            </div>
            
            <!-- Footer -->
            <div class="card-footer">
                <span class="timestamp">📅 {{ ride.created_at }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">🚫</div>
        <h3>No Ride Requests</h3>
        <p>New requests will appear here when passengers book rides</p>
    </div>
    {% endif %}
    
    <!-- Bottom Actions -->
    <div class="bottom-actions">
        <a href="{{ url_for('logout') }}" class="btn-logout">
            🚪 Logout
        </a>
    </div>
</div>

<script>
// Pool Mode Management
let poolModeActive = false;
const selectedRides = new Set();

const togglePoolBtn = document.getElementById('togglePoolBtn');
const poolModeBanner = document.getElementById('poolModeBanner');
const acceptPoolBtn = document.getElementById('acceptPoolBtn');
const cancelPoolBtn = document.getElementById('cancelPoolBtn');
const selectedCountSpan = document.getElementById('selectedCount');
const poolSelectBoxes = document.querySelectorAll('.pool-select-box');
const poolCheckboxes = document.querySelectorAll('.pool-checkbox');

// Toggle pool mode
togglePoolBtn.addEventListener('click', function() {
    poolModeActive = !poolModeActive;
    
    if (poolModeActive) {
        // Activate pool mode
        togglePoolBtn.classList.add('active');
        togglePoolBtn.querySelector('.pool-text').textContent = 'Disable Pool Mode';
        poolModeBanner.style.display = 'block';
        poolSelectBoxes.forEach(box => box.style.display = 'flex');
    } else {
        // Deactivate pool mode
        togglePoolBtn.classList.remove('active');
        togglePoolBtn.querySelector('.pool-text').textContent = 'Enable Pool Mode';
        poolModeBanner.style.display = 'none';
        poolSelectBoxes.forEach(box => box.style.display = 'none');
        selectedRides.clear();
        poolCheckboxes.forEach(cb => cb.checked = false);
        updateSelectedCount();
    }
});

// Cancel pool mode
cancelPoolBtn.addEventListener('click', function() {
    poolModeActive = false;
    togglePoolBtn.classList.remove('active');
    togglePoolBtn.querySelector('.pool-text').textContent = 'Enable Pool Mode';
    poolModeBanner.style.display = 'none';
    poolSelectBoxes.forEach(box => box.style.display = 'none');
    selectedRides.clear();
    poolCheckboxes.forEach(cb => cb.checked = false);
    updateSelectedCount();
});

// Handle checkbox selection
poolCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function(e) {
        const rideId = parseInt(e.target.dataset.rideId);
        
        if (e.target.checked) {
            selectedRides.add(rideId);
        } else {
            selectedRides.delete(rideId);
        }
        
        updateSelectedCount();
    });
});

// Update selected count and button state
function updateSelectedCount() {
    const count = selectedRides.size;
    selectedCountSpan.textContent = count;
    acceptPoolBtn.disabled = count < 2;
}

// Accept pool rides
acceptPoolBtn.addEventListener('click', function() {
    if (selectedRides.size < 2) {
        alert('Please select at least 2 rides for pool mode');
        return;
    }
    
    const rideIds = Array.from(selectedRides);
    window.location.href = `/multi_route_view/${rideIds.join(',')}`;
});
</script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        background: #f5f7fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .rider-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }
    
    /* Header */
    .rider-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 32px;
        border-radius: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);
    }
    
    .header-left h1 {
        color: white;
        font-size: 32px;
        margin-bottom: 8px;
        font-weight: 700;
    }
    
    .welcome-text {
        color: rgba(255, 255, 255, 0.95);
        font-size: 16px;
    }
    
    .status-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 12px 24px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        font-weight: 600;
        backdrop-filter: blur(10px);
    }
    
    .status-dot {
        width: 10px;
        height: 10px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.1); }
    }
    
    /* Pool Mode Banner */
    .pool-mode-banner {
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        padding: 20px 24px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    .pool-banner-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
    }
    
    .pool-info h3 {
        font-size: 20px;
        margin-bottom: 6px;
    }
    
    .pool-info p {
        opacity: 0.9;
        font-size: 14px;
    }
    
    .pool-actions {
        display: flex;
        gap: 12px;
    }
    
    .btn-pool-accept, .btn-pool-cancel {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 15px;
    }
    
    .btn-pool-accept {
        background: #10b981;
        color: white;
    }
    
    .btn-pool-accept:hover:not(:disabled) {
        background: #059669;
        transform: translateY(-2px);
    }
    
    .btn-pool-accept:disabled {
        background: #6b7280;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .btn-pool-cancel {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    .btn-pool-cancel:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* Statistics */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .stat-box {
        background: white;
        padding: 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
    }
    
    .stat-box:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    
    .stat-icon {
        font-size: 42px;
    }
    
    .stat-number {
        font-size: 36px;
        font-weight: 700;
        color: #1f2937;
        line-height: 1;
        margin-bottom: 6px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }
    
    /* Location Card */
    .location-card {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        padding: 20px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .location-icon {
        font-size: 36px;
    }
    
    .location-details h3 {
        font-size: 18px;
        margin-bottom: 6px;
    }
    
    .coordinates {
        font-family: 'Courier New', monospace;
        opacity: 0.95;
        font-size: 14px;
    }
    
    /* Section Toolbar */
    .section-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .section-toolbar h2 {
        font-size: 24px;
        color: #1f2937;
    }
    
    .btn-toggle-pool {
        background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    .btn-toggle-pool:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
    }
    
    .btn-toggle-pool.active {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    /* Rides Container */
    .rides-container {
        display: grid;
        gap: 20px;
    }
    
    /* Ride Card */
    .ride-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
        position: relative;
        border: 2px solid transparent;
    }
    
    .ride-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .card-accepted {
        border-color: #10b981;
        background: linear-gradient(to bottom, #f0fdf4, white);
    }
    
    /* Pool Select */
    .pool-select-box {
        position: absolute;
        top: 20px;
        right: 20px;
        display: none;
        align-items: center;
        gap: 8px;
    }
    
    .pool-checkbox {
        width: 24px;
        height: 24px;
        cursor: pointer;
        accent-color: #8b5cf6;
    }
    
    /* Status Tag */
    .status-tag {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 16px;
    }
    
    .status-pending {
        background: #fef3c7;
        color: #d97706;
    }
    
    .status-accepted {
        background: #d1fae5;
        color: #059669;
    }
    
    .status-completed {
        background: #e0e7ff;
        color: #4f46e5;
    }
    
    /* User Section */
    .user-section {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f3f4f6;
    }
    
    .user-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: 700;
    }
    
    .user-name {
        font-size: 20px;
        color: #1f2937;
        margin-bottom: 4px;
    }
    
    .user-email {
        font-size: 14px;
        color: #6b7280;
    }
    
    /* Route Section */
    .route-section {
        margin-bottom: 20px;
    }
    
    .route-points {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .point {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }
    
    .point-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .point-dot.blue {
        background: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }
    
    .point-dot.red {
        background: #ef4444;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
    }
    
    .point-label {
        display: block;
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
    }
    
    .point-location {
        display: block;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }
    
    .route-connector {
        width: 60px;
        height: 2px;
        background: linear-gradient(to right, #3b82f6, #ef4444);
        margin: 0 16px;
    }
    
    .route-path-text {
        background: #f9fafb;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        color: #4b5563;
    }
    
    /* Metrics */
    .ride-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .metric {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 10px;
    }
    
    .metric.highlighted {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border: 2px solid #f59e0b;
    }
    
    .metric-icon {
        font-size: 28px;
    }
    
    .metric-value {
        font-size: 22px;
        font-weight: 700;
        color: #1f2937;
        line-height: 1;
        margin-bottom: 4px;
    }
    
    .metric-label {
        font-size: 12px;
        color: #6b7280;
    }
    
    /* Card Actions */
    .card-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .btn-action {
        padding: 14px 20px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.3s;
    }
    
    .btn-view {
        background: #f3f4f6;
        color: #1f2937;
    }
    
    .btn-view:hover {
        background: #e5e7eb;
        transform: scale(1.02);
    }
    
    .btn-accept {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-accept:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    
    /* Card Footer */
    .card-footer {
        padding-top: 16px;
        border-top: 2px solid #f3f4f6;
    }
    
    .timestamp {
        font-size: 13px;
        color: #9ca3af;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .empty-state h3 {
        font-size: 24px;
        color: #1f2937;
        margin-bottom: 12px;
    }
    
    .empty-state p {
        font-size: 16px;
        color: #6b7280;
    }
    
    /* Bottom Actions */
    .bottom-actions {
        margin-top: 32px;
        text-align: center;
    }
    
    .btn-logout {
        padding: 14px 32px;
        background: #ef4444;
        color: white;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .btn-logout:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .rider-header {
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }
        
        .stats-container {
            grid-template-columns: 1fr;
        }
        
        .section-toolbar {
            flex-direction: column;
            gap: 16px;
            align-items: stretch;
        }
        
        .pool-banner-content {
            flex-direction: column;
            gap: 16px;
            align-items: stretch;
        }
        
        .card-actions {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}
